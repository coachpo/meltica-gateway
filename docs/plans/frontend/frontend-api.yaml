openapi: 3.1.0
info:
  title: Meltica Control Plane API
  version: 1.0.0
servers:
  - url: http://localhost:8880
paths:
  /strategies:
    get:
      summary: List available strategies
      responses:
        '200':
          description: A list of strategies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyListResponse'
  /strategies/modules:
    get:
      summary: List strategy modules
      responses:
        '200':
          description: Strategy modules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyModulesResponse'
    post:
      summary: Create or update a strategy module
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StrategyModulePayload'
      responses:
        '200':
          description: Updated module
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyModuleOperationResponse'
  /providers:
    get:
      summary: List providers
      responses:
        '200':
          description: Providers response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProvidersResponse'
  /strategy/instances:
    get:
      summary: List strategy instances
      responses:
        '200':
          description: Instances response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstancesResponse'
components:
  schemas:
    StrategyConfig:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
        description:
          type: string
        default: {}
        required:
          type: boolean
      required:
        - name
        - type
        - description
        - required
    Strategy:
      type: object
      properties:
        name:
          type: string
        displayName:
          type: string
        description:
          type: string
        version:
          type: string
        config:
          type: array
          items:
            $ref: '#/components/schemas/StrategyConfig'
        events:
          type: array
          items:
            type: string
      required:
        - name
        - displayName
        - description
        - config
        - events
    StrategyListResponse:
      type: object
      properties:
        strategies:
          type: array
          items:
            $ref: '#/components/schemas/Strategy'
      required:
        - strategies
    StrategyDiagnostic:
      type: object
      properties:
        stage:
          type: string
        message:
          type: string
        line:
          type: integer
        column:
          type: integer
        hint:
          type: string
    StrategyModuleRevision:
      type: object
      properties:
        hash:
          type: string
        tag:
          type: string
        path:
          type: string
        version:
          type: string
        size:
          type: integer
        retired:
          type: boolean
      required:
        - hash
        - path
        - size
    ModuleRunningSummary:
      type: object
      properties:
        hash:
          type: string
        instances:
          type: array
          items:
            type: string
          nullable: true
        count:
          type: integer
        firstSeen:
          type: string
          nullable: true
        lastSeen:
          type: string
          nullable: true
        running:
          type: boolean
      required:
        - hash
        - instances
        - count
    StrategyModuleResolution:
      type: object
      properties:
        name:
          type: string
        hash:
          type: string
        tag:
          type: string
        version:
          type: string
        file:
          type: string
        path:
          type: string
      required:
        - name
        - hash
    StrategyModuleSummary:
      type: object
      properties:
        name:
          type: string
        file:
          type: string
        path:
          type: string
        hash:
          type: string
        version:
          type: string
        tags:
          type: array
          items:
            type: string
        tagAliases:
          type: object
          additionalProperties:
            type: string
        revisions:
          type: array
          items:
            $ref: '#/components/schemas/StrategyModuleRevision'
        running:
          type: array
          items:
            $ref: '#/components/schemas/ModuleRunningSummary'
          nullable: true
        size:
          type: integer
        metadata:
          $ref: '#/components/schemas/Strategy'
      required:
        - name
        - file
        - path
        - hash
        - tags
        - size
        - metadata
    StrategyModulesResponse:
      type: object
      properties:
        modules:
          type: array
          items:
            $ref: '#/components/schemas/StrategyModuleSummary'
        total:
          type: integer
        offset:
          type: integer
        limit:
          type: integer
          nullable: true
        strategyDirectory:
          type: string
      required:
        - modules
    StrategyModulePayload:
      type: object
      properties:
        filename:
          type: string
        source:
          type: string
        name:
          type: string
        tag:
          type: string
        aliases:
          type: array
          items:
            type: string
        promoteLatest:
          type: boolean
      required:
        - source
    StrategyModuleOperationResponse:
      type: object
      properties:
        filename:
          type: string
        status:
          type: string
        strategyDirectory:
          type: string
        module:
          allOf:
            - $ref: '#/components/schemas/StrategyModuleResolution'
          nullable: true
      required:
        - status
        - strategyDirectory
    ProviderSettings:
      type: object
      additionalProperties: {}
    ProviderStatus:
      type: string
      enum:
        - pending
        - starting
        - running
        - stopped
        - failed
    Provider:
      type: object
      properties:
        name:
          type: string
        adapter:
          type: string
        identifier:
          type: string
        instrumentCount:
          type: integer
        settings:
          $ref: '#/components/schemas/ProviderSettings'
        running:
          type: boolean
        status:
          $ref: '#/components/schemas/ProviderStatus'
        startupError:
          type: string
        dependentInstances:
          type: array
          items:
            type: string
          nullable: true
        dependentInstanceCount:
          type: integer
          nullable: true
      required:
        - name
        - adapter
        - identifier
        - instrumentCount
        - settings
        - running
        - status
    Instrument:
      type: object
      properties:
        symbol:
          type: string
        type:
          type: string
        baseAsset:
          type: string
          nullable: true
        baseCurrency:
          type: string
          nullable: true
        quoteAsset:
          type: string
          nullable: true
        quoteCurrency:
          type: string
          nullable: true
        venue:
          type: string
          nullable: true
        expiry:
          type: string
          nullable: true
        contractValue:
          type: number
          nullable: true
        contractCurrency:
          type: string
          nullable: true
        strike:
          type: number
          nullable: true
        optionType:
          type: string
          nullable: true
        priceIncrement:
          type: number
          nullable: true
        quantityIncrement:
          type: number
          nullable: true
        pricePrecision:
          type: number
          nullable: true
        quantityPrecision:
          type: number
          nullable: true
        notionalPrecision:
          type: number
          nullable: true
        minNotional:
          type: number
          nullable: true
        minQuantity:
          type: number
          nullable: true
        maxQuantity:
          type: number
          nullable: true
      required:
        - symbol
    SettingsSchema:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
        default: {}
        description:
          type: string
          nullable: true
        required:
          type: boolean
      required:
        - name
        - type
        - required
    AdapterMetadata:
      type: object
      properties:
        identifier:
          type: string
        displayName:
          type: string
        venue:
          type: string
        description:
          type: string
        capabilities:
          type: array
          items:
            type: string
        settingsSchema:
          type: array
          items:
            $ref: '#/components/schemas/SettingsSchema'
      required:
        - identifier
        - displayName
        - venue
        - capabilities
        - settingsSchema
    ProviderDetail:
      type: object
      properties:
        name:
          type: string
        adapter:
          $ref: '#/components/schemas/AdapterMetadata'
        identifier:
          type: string
        instrumentCount:
          type: integer
        settings:
          $ref: '#/components/schemas/ProviderSettings'
        running:
          type: boolean
        status:
          $ref: '#/components/schemas/ProviderStatus'
        startupError:
          type: string
        dependentInstances:
          type: array
          items:
            type: string
          nullable: true
        dependentInstanceCount:
          type: integer
          nullable: true
        instruments:
          type: array
          items:
            $ref: '#/components/schemas/Instrument'
      required:
        - name
        - adapter
        - identifier
        - instrumentCount
        - settings
        - running
        - status
        - instruments
    ProvidersResponse:
      type: object
      properties:
        providers:
          type: array
          items:
            $ref: '#/components/schemas/Provider'
      required:
        - providers
    ProviderRequest:
      type: object
      properties:
        name:
          type: string
        adapter:
          type: object
          properties:
            identifier:
              type: string
            config:
              type: object
              additionalProperties: {}
          required:
            - identifier
            - config
        enabled:
          type: boolean
      required:
        - name
        - adapter
    ProviderSymbols:
      type: object
      properties:
        symbols:
          type: array
          items:
            type: string
      required:
        - symbols
    LambdaStrategySpec:
      type: object
      properties:
        identifier:
          type: string
        config:
          type: object
          additionalProperties: {}
        selector:
          type: string
        tag:
          type: string
        hash:
          type: string
        version:
          type: string
      required:
        - identifier
        - config
    InstanceLinks:
      type: object
      properties:
        self:
          type: string
        usage:
          type: string
    ModuleRevisionUsage:
      type: object
      properties:
        strategy:
          type: string
        hash:
          type: string
        instances:
          type: array
          items:
            type: string
          nullable: true
        count:
          type: integer
        firstSeen:
          type: string
          nullable: true
        lastSeen:
          type: string
          nullable: true
        running:
          type: boolean
      required:
        - strategy
        - hash
        - instances
        - count
    InstanceSummary:
      type: object
      properties:
        id:
          type: string
        strategyIdentifier:
          type: string
        strategyTag:
          type: string
        strategyHash:
          type: string
        strategyVersion:
          type: string
        strategySelector:
          type: string
        providers:
          type: array
          items:
            type: string
        aggregatedSymbols:
          type: array
          items:
            type: string
        running:
          type: boolean
        baseline:
          type: boolean
        dynamic:
          type: boolean
        createdAt:
          type: string
          nullable: true
        updatedAt:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
          additionalProperties: {}
        usage:
          $ref: '#/components/schemas/ModuleRevisionUsage'
        links:
          $ref: '#/components/schemas/InstanceLinks'
      required:
        - id
        - strategyIdentifier
        - providers
        - aggregatedSymbols
        - running
    InstanceSpec:
      type: object
      properties:
        id:
          type: string
        strategy:
          $ref: '#/components/schemas/LambdaStrategySpec'
        scope:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ProviderSymbols'
        providers:
          type: array
          items:
            type: string
        aggregatedSymbols:
          type: array
          items:
            type: string
        running:
          type: boolean
      required:
        - id
        - strategy
        - scope
    InstancesResponse:
      type: object
      properties:
        instances:
          type: array
          items:
            $ref: '#/components/schemas/InstanceSummary'
      required:
        - instances
    ExecutionRecord:
      type: object
      properties:
        orderId:
          type: string
        provider:
          type: string
        strategyInstance:
          type: string
        executionId:
          type: string
        quantity:
          type: string
        price:
          type: string
        fee:
          type: string
          nullable: true
        feeAsset:
          type: string
          nullable: true
        liquidity:
          type: string
          nullable: true
        tradedAt:
          type: integer
        metadata:
          type: object
          additionalProperties: {}
        createdAt:
          type: integer
      required:
        - orderId
        - provider
        - strategyInstance
        - executionId
        - quantity
        - price
        - tradedAt
        - createdAt
    ExecutionHistoryResponse:
      type: object
      properties:
        executions:
          type: array
          items:
            $ref: '#/components/schemas/ExecutionRecord'
        count:
          type: integer
      required:
        - executions
        - count
    OrderRecord:
      type: object
      properties:
        id:
          type: string
        provider:
          type: string
        strategyInstance:
          type: string
        clientOrderId:
          type: string
        symbol:
          type: string
        side:
          type: string
        type:
          type: string
        quantity:
          type: string
        price:
          type: string
          nullable: true
        state:
          type: string
        externalReference:
          type: string
          nullable: true
        placedAt:
          type: integer
        metadata:
          type: object
          additionalProperties: {}
        acknowledgedAt:
          type: integer
          nullable: true
        completedAt:
          type: integer
          nullable: true
        createdAt:
          type: integer
        updatedAt:
          type: integer
      required:
        - id
        - provider
        - strategyInstance
        - clientOrderId
        - symbol
        - side
        - type
        - quantity
        - state
        - placedAt
        - createdAt
        - updatedAt
    OrderHistoryResponse:
      type: object
      properties:
        orders:
          type: array
          items:
            $ref: '#/components/schemas/OrderRecord'
        count:
          type: integer
      required:
        - orders
        - count
    BalanceRecord:
      type: object
      properties:
        provider:
          type: string
        asset:
          type: string
        total:
          type: string
        available:
          type: string
        snapshotAt:
          type: integer
        metadata:
          type: object
          additionalProperties: {}
        createdAt:
          type: integer
        updatedAt:
          type: integer
      required:
        - provider
        - asset
        - total
        - available
        - snapshotAt
        - createdAt
        - updatedAt
    BalanceHistoryResponse:
      type: object
      properties:
        balances:
          type: array
          items:
            $ref: '#/components/schemas/BalanceRecord'
        count:
          type: integer
      required:
        - balances
        - count
    CircuitBreakerConfig:
      type: object
      properties:
        enabled:
          type: boolean
        threshold:
          type: number
        cooldown:
          type: string
      required:
        - enabled
        - threshold
        - cooldown
    RiskConfig:
      type: object
      properties:
        maxPositionSize:
          type: string
        maxNotionalValue:
          type: string
        notionalCurrency:
          type: string
        orderThrottle:
          type: number
        orderBurst:
          type: number
        maxConcurrentOrders:
          type: number
        priceBandPercent:
          type: number
        allowedOrderTypes:
          type: array
          items:
            type: string
        killSwitchEnabled:
          type: boolean
        maxRiskBreaches:
          type: number
        circuitBreaker:
          $ref: '#/components/schemas/CircuitBreakerConfig'
      required:
        - maxPositionSize
        - maxNotionalValue
        - notionalCurrency
        - orderThrottle
        - orderBurst
        - maxConcurrentOrders
        - priceBandPercent
        - allowedOrderTypes
        - killSwitchEnabled
        - maxRiskBreaches
        - circuitBreaker
    FanoutWorkersSetting:
      oneOf:
        - type: number
        - type: string
    EventbusRuntimeConfig:
      type: object
      properties:
        bufferSize:
          type: number
        fanoutWorkers:
          $ref: '#/components/schemas/FanoutWorkersSetting'
      required:
        - bufferSize
        - fanoutWorkers
    ObjectPoolRuntimeConfig:
      type: object
      properties:
        size:
          type: number
        waitQueueSize:
          type: number
      required:
        - size
        - waitQueueSize
    PoolRuntimeConfig:
      type: object
      properties:
        event:
          $ref: '#/components/schemas/ObjectPoolRuntimeConfig'
        orderRequest:
          $ref: '#/components/schemas/ObjectPoolRuntimeConfig'
      required:
        - event
        - orderRequest
    ApiServerConfig:
      type: object
      properties:
        addr:
          type: string
      required:
        - addr
    TelemetryConfig:
      type: object
      properties:
        otlpEndpoint:
          type: string
        serviceName:
          type: string
        otlpInsecure:
          type: boolean
        enableMetrics:
          type: boolean
      required:
        - otlpEndpoint
        - serviceName
        - otlpInsecure
        - enableMetrics
    RuntimeConfig:
      type: object
      properties:
        eventbus:
          $ref: '#/components/schemas/EventbusRuntimeConfig'
        pools:
          $ref: '#/components/schemas/PoolRuntimeConfig'
        risk:
          $ref: '#/components/schemas/RiskConfig'
        apiServer:
          $ref: '#/components/schemas/ApiServerConfig'
        telemetry:
          $ref: '#/components/schemas/TelemetryConfig'
      required:
        - eventbus
        - pools
        - risk
        - apiServer
        - telemetry
    RuntimeConfigSource:
      type: string
      enum:
        - runtime
        - file
        - bootstrap
    RuntimeConfigSnapshot:
      type: object
      properties:
        config:
          $ref: '#/components/schemas/RuntimeConfig'
        source:
          $ref: '#/components/schemas/RuntimeConfigSource'
        persistedAt:
          type: string
          nullable: true
        filePath:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
          additionalProperties: {}
      required:
        - config
        - source
    ProviderRuntimeMetadata:
      type: object
      properties:
        name:
          type: string
        adapter:
          type: string
        identifier:
          type: string
        instrumentCount:
          type: integer
        settings:
          type: object
          nullable: true
          additionalProperties: {}
        running:
          type: boolean
        status:
          $ref: '#/components/schemas/ProviderStatus'
        startupError:
          type: string
      required:
        - name
        - adapter
        - identifier
        - instrumentCount
        - running
        - status
    LambdaInstanceSnapshot:
      type: object
      properties:
        id:
          type: string
        strategy:
          $ref: '#/components/schemas/LambdaStrategySpec'
        providers:
          type: array
          items:
            type: string
        providerSymbols:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ProviderSymbols'
        aggregatedSymbols:
          type: array
          items:
            type: string
        running:
          type: boolean
        baseline:
          type: boolean
        dynamic:
          type: boolean
        createdAt:
          type: string
          nullable: true
        updatedAt:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
          additionalProperties: {}
      required:
        - id
        - strategy
        - providers
        - providerSymbols
        - aggregatedSymbols
        - running
    ConfigBackup:
      type: object
      properties:
        version:
          type: string
        generatedAt:
          type: string
        environment:
          type: string
        meta:
          type: object
          properties:
            name:
              type: string
            version:
              type: string
            description:
              type: string
        runtime:
          $ref: '#/components/schemas/RuntimeConfig'
        providers:
          type: object
          properties:
            config:
              type: object
              nullable: true
              additionalProperties:
                type: object
                additionalProperties: {}
            runtime:
              type: array
              items:
                $ref: '#/components/schemas/ProviderRuntimeMetadata'
          required:
            - config
            - runtime
        lambdas:
          type: object
          properties:
            instances:
              type: array
              items:
                $ref: '#/components/schemas/LambdaInstanceSnapshot'
          required:
            - instances
      required:
        - version
        - generatedAt
        - environment
        - meta
        - runtime
        - providers
        - lambdas
    RestoreConfigResponse:
      type: object
      properties:
        status:
          type: string
        providers:
          type: integer
        lambdas:
          type: integer
      required:
        - status
        - providers
        - lambdas
    ContextBackupPayload:
      type: object
      properties:
        providers:
          type: array
          items:
            type: object
            additionalProperties: {}
        lambdas:
          type: array
          items:
            $ref: '#/components/schemas/InstanceSpec'
        risk:
          type: object
          additionalProperties: {}
      required:
        - providers
        - lambdas
        - risk
    RestoreContextResponse:
      type: object
      properties:
        status:
          type: string
      required:
        - status
    StrategyRefreshRequest:
      type: object
      properties:
        hashes:
          type: array
          items:
            type: string
        strategies:
          type: array
          items:
            type: string
    StrategyRefreshResult:
      type: object
      properties:
        selector:
          type: string
        strategy:
          type: string
        hash:
          type: string
        previousHash:
          type: string
        instances:
          type: array
          items:
            type: string
        reason:
          type: string
      required:
        - selector
    StrategyRefreshResponse:
      type: object
      properties:
        status:
          type: string
        results:
          type: array
          items:
            $ref: '#/components/schemas/StrategyRefreshResult'
      required:
        - status
    StrategyModuleUsageResponse:
      type: object
      properties:
        selector:
          type: string
        strategy:
          type: string
        hash:
          type: string
        usage:
          $ref: '#/components/schemas/ModuleRevisionUsage'
        instances:
          type: array
          items:
            $ref: '#/components/schemas/InstanceSummary'
        total:
          type: integer
        offset:
          type: integer
        limit:
          type: integer
          nullable: true
      required:
        - selector
        - strategy
        - hash
        - usage
        - instances
        - total
        - offset
    StrategyRegistryLocation:
      type: object
      properties:
        tag:
          type: string
        path:
          type: string
      required:
        - tag
        - path
    StrategyRegistryEntry:
      type: object
      properties:
        tags:
          type: object
          additionalProperties:
            type: string
        hashes:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/StrategyRegistryLocation'
      required:
        - tags
        - hashes
    StrategyRegistryExport:
      type: object
      properties:
        registry:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/StrategyRegistryEntry'
        usage:
          type: array
          items:
            $ref: '#/components/schemas/ModuleRevisionUsage'
      required:
        - registry
        - usage
    ApiErrorPayload:
      type: object
      properties:
        status:
          type: string
        error:
          type: string
        message:
          type: string
        diagnostics:
          type: array
          items:
            $ref: '#/components/schemas/StrategyDiagnostic'
      required:
        - error
    StrategyErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ApiErrorPayload'
    StrategyValidationErrorResponse:
      allOf:
        - $ref: '#/components/schemas/StrategyErrorResponse'
        - type: object
          properties:
            error:
              type: string
              const: strategy_validation_failed
            message:
              type: string
          required:
            - error
            - message
    OutboxAggregateType:
      type: string
    OutboxEvent:
      type: object
      properties:
        id:
          type: integer
        aggregateType:
          $ref: '#/components/schemas/OutboxAggregateType'
        aggregateID:
          type: string
        eventType:
          type: string
        payload:
          type: object
          additionalProperties: {}
        headers:
          type: object
          additionalProperties: {}
        availableAt:
          type: string
        publishedAt:
          type: string
          nullable: true
        attempts:
          type: integer
        lastError:
          type: string
          nullable: true
        delivered:
          type: boolean
        createdAt:
          type: string
      required:
        - id
        - aggregateType
        - aggregateID
        - eventType
        - payload
        - headers
        - availableAt
        - attempts
        - delivered
        - createdAt
    OutboxListResponse:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/OutboxEvent'
        count:
          type: integer
      required:
        - events
        - count
    OutboxDeleteResponse:
      type: object
      properties:
        id:
          type: integer
        status:
          type: string
      required:
        - id
        - status
    OutboxQuery:
      type: object
      properties:
        limit:
          type: integer
        delivered:
          type: boolean
        aggregateType:
          type: string
        aggregateID:
          type: string
